name: Security Scan

on:
  schedule:
    # 매일 09:00 KST (00:00 UTC)
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  issues: write

jobs:
  audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        id: audit
        continue-on-error: true
        run: |
          pnpm audit --json > audit-result.json 2>&1 || true
          # high 이상 취약점 수 카운트
          HIGH_COUNT=$(jq '[.advisories // {} | to_entries[] | select(.value.severity == "high" or .value.severity == "critical")] | length' audit-result.json 2>/dev/null || echo "0")
          echo "high_count=$HIGH_COUNT" >> "$GITHUB_OUTPUT"
          echo "Found $HIGH_COUNT high/critical vulnerabilities"

      - name: Create issue for high vulnerabilities
        if: steps.audit.outputs.high_count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const count = '${{ steps.audit.outputs.high_count }}';
            const date = new Date().toISOString().split('T')[0];

            // 중복 이슈 방지: 기존 열린 이슈 확인
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security',
              state: 'open',
            });
            const hasExisting = existing.data.some(i => i.title.includes('보안 취약점'));
            if (hasExisting) {
              console.log('Security issue already exists, skipping');
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[보안] ${count}개 High/Critical 취약점 감지 (${date})`,
              labels: ['security', 'automated'],
              body: `## 보안 스캔 결과\n\nHigh/Critical 취약점 **${count}개** 감지됨.\n\n\`pnpm audit\` 실행 후 확인 필요.\n\n---\n자동 생성됨 (Security Scan workflow)`,
            });

name: Mirror Packages

on:
  push:
    branches: [main]
    paths: ["packages/**"]
  workflow_dispatch:
    inputs:
      force_all:
        description: "모든 패키지를 강제 미러링"
        required: false
        default: "false"
        type: boolean

concurrency:
  group: mirror-packages
  cancel-in-progress: false

env:
  OWNER: krdn
  MONOREPO_URL: https://github.com/krdn/ai-afterschool-ex

jobs:
  # 변경된 패키지 감지
  detect-changes:
    name: Detect Changed Packages
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed packages
        id: set-matrix
        run: |
          # 패키지 매핑 (패키지 디렉토리 → 독립 레포명)
          declare -A PKG_MAP=(
            ["packages/shared"]="ais-shared"
            ["packages/db"]="ais-db"
            ["packages/ui"]="ais-ui"
            ["packages/analysis"]="ais-analysis"
            ["packages/ai-engine"]="ais-ai-engine"
            ["packages/matching"]="ais-matching"
            ["packages/counseling"]="ais-counseling"
            ["packages/report"]="ais-report"
          )

          FORCE_ALL="${{ inputs.force_all }}"
          PACKAGES=()

          if [[ "${FORCE_ALL}" == "true" ]]; then
            echo "Force all: 모든 패키지를 미러링합니다."
            for pkg_dir in "${!PKG_MAP[@]}"; do
              pkg_name="${pkg_dir#packages/}"
              repo_name="${PKG_MAP[$pkg_dir]}"
              PACKAGES+=("{\"pkg\":\"${pkg_name}\",\"repo\":\"${repo_name}\",\"dir\":\"${pkg_dir}\"}")
            done
          else
            # HEAD~1과 비교하여 변경된 파일 감지
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")

            if [[ -z "${CHANGED_FILES}" ]]; then
              echo "변경된 파일이 없습니다."
              echo "matrix={\"include\":[]}" >> "$GITHUB_OUTPUT"
              echo "has_changes=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            echo "변경된 파일:"
            echo "${CHANGED_FILES}"
            echo ""

            for pkg_dir in "${!PKG_MAP[@]}"; do
              if echo "${CHANGED_FILES}" | grep -q "^${pkg_dir}/"; then
                pkg_name="${pkg_dir#packages/}"
                repo_name="${PKG_MAP[$pkg_dir]}"
                echo "  → ${pkg_name} 변경 감지"
                PACKAGES+=("{\"pkg\":\"${pkg_name}\",\"repo\":\"${repo_name}\",\"dir\":\"${pkg_dir}\"}")
              fi
            done
          fi

          if [[ ${#PACKAGES[@]} -eq 0 ]]; then
            echo "미러링할 패키지가 없습니다."
            echo "matrix={\"include\":[]}" >> "$GITHUB_OUTPUT"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            # JSON matrix 생성
            MATRIX_JSON=$(printf '%s,' "${PACKAGES[@]}")
            MATRIX_JSON="{\"include\":[${MATRIX_JSON%,}]}"
            echo "matrix=${MATRIX_JSON}" >> "$GITHUB_OUTPUT"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo ""
            echo "미러링 대상: ${#PACKAGES[@]}개 패키지"
          fi

  # 변경된 패키지를 독립 레포에 동기화
  mirror:
    name: "Mirror: ${{ matrix.pkg }}"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Get commit info
        id: commit-info
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%s)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "message=${COMMIT_MSG}" >> "$GITHUB_OUTPUT"
          echo "sha=${COMMIT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Prepare package files
        run: |
          WORK_DIR=$(mktemp -d)
          echo "WORK_DIR=${WORK_DIR}" >> "$GITHUB_ENV"

          # 패키지 파일을 임시 디렉토리로 rsync
          rsync -av --delete \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='.turbo' \
            --exclude='.next' \
            --exclude='coverage' \
            "${{ matrix.dir }}/" "${WORK_DIR}/"

          # workspace:* 의존성을 ^0.0.1로 변환
          if [[ -f "${WORK_DIR}/package.json" ]]; then
            sed -i 's/"workspace:\*"/"^0.0.1"/g; s/"workspace:~\*"/"^0.0.1"/g; s/"workspace:^\*"/"^0.0.1"/g' "${WORK_DIR}/package.json"
          fi

          # LICENSE 복사
          if [[ -f LICENSE ]]; then
            cp LICENSE "${WORK_DIR}/LICENSE"
          fi

          echo "준비된 파일:"
          ls -la "${WORK_DIR}/"

      - name: Sync to independent repo
        env:
          GH_TOKEN: ${{ secrets.MIRROR_TOKEN }}
        run: |
          TARGET_REPO="${{ env.OWNER }}/${{ matrix.repo }}"
          CLONE_DIR=$(mktemp -d)

          # 독립 레포 clone
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${TARGET_REPO}.git" "${CLONE_DIR}"

          # .git 보존, 나머지 파일 교체
          cd "${CLONE_DIR}"
          find . -maxdepth 1 -not -name '.git' -not -name '.' -exec rm -rf {} +
          cp -a "${WORK_DIR}/." .

          # 변경사항 확인
          if git diff --quiet && git diff --cached --quiet && [[ -z "$(git ls-files --others --exclude-standard)" ]]; then
            echo "변경사항 없음 — skip"
            exit 0
          fi

          # 커밋 및 푸시
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "sync: ${{ steps.commit-info.outputs.message }}" \
            -m "Source: ${MONOREPO_URL}/tree/main/${{ matrix.dir }}" \
            -m "Commit: ${MONOREPO_URL}/commit/${{ steps.commit-info.outputs.sha }}"
          git push origin main
          echo "동기화 완료: ${TARGET_REPO}"
